name: Sync How-To Markdown Files to Documentation Repo

on:
  push:
    branches:
      - 'main'
      - 'test-howto-sync'
    paths:
      - '**/howto-*.md'

jobs:
  sync-markdown-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Sparse checkout and sync files
        env:
          TARGET_REPO: 'https://github.com/langgenius/dify-docs.git'
          TARGET_BRANCH: 'test-howto-sync'
          TARGET_SECTION_EN: 'en/tutorials/'
          TARGET_SECTION_ZH: 'zh_CN/tutorials/'
          ACCESS_TOKEN: ${{ secrets.DIFY_DOCS_ACCESS_TOKEN }}
        run: |
          CHANGED_HOWTOS=$(git diff --no-renames --name-only --diff-filter=AMDR ${{ github.event.before }}..${{ github.event.after }} | grep -e 'howto-.*\.md$' || true)

          echo "Changed how-to files:"
          echo "$CHANGED_HOWTOS"
          
          if [ -z "$CHANGED_HOWTOS" ]; then
            echo "No new how-to file changes to sync"
            exit 0
          fi

          # sparse-checkout dify-docs repo
          git clone --filter=blob:none --sparse $TARGET_REPO dify-docs-sparse
          
          cd dify-docs-sparse
          git checkout $TARGET_BRANCH
          echo "checked out target branch: $TARGET_BRANCH"
          
          # set sparse checked out directories
          git sparse-checkout set $TARGET_SECTION_EN $TARGET_SECTION_ZH
          echo "set sparse checked out directories of dify-docs repo"

          # Sync files to different language directories
          for file in $CHANGED_HOWTOS; do
            echo "Processing file: $file"
            if [[ $file == *"_CN.md" ]]; then
              TARGET_DIR=$TARGET_SECTION_ZH
            else
              TARGET_DIR=$TARGET_SECTION_EN
            fi
            echo "Target directory: $TARGET_DIR"

            if [ -f "../$file" ]; then
              echo "Copying file to target directory"
              cp "../$file" "$TARGET_DIR"
            else
              echo "File not found, removing from target directory"
              git rm "$TARGET_DIR$(basename $file)" || true
            fi
          done

          git add --all
          
          GIT_STATUS=$(git status --porcelain)
          echo "staged changes: $GIT_STATUS"

          if [ -z "$GIT_STATUS" ]; then
            echo "Nothing to commit, skipping push"
          else
            git config user.name github-actions
            git config user.email github-actions@github.com

            git commit -m "Sync how-to markdown files from PR #${{ github.event.pull_request.number }} on main repo"
            
            echo "Pushing files to $TARGET_BRANCH branch of $TARGET_REPO"
            if git push https://${ACCESS_TOKEN}@${TARGET_REPO#https://} HEAD:${TARGET_BRANCH}; then
              echo "Files have been successfully pushed to $TARGET_BRANCH branch of $TARGET_REPO"
            else
              echo "Failed to push files to $TARGET_BRANCH branch of $TARGET_REPO, please manually sync docs"
              exit 1
            fi
          fi
          
